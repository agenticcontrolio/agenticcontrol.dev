---
// TutorialScripts.astro
// Shared JavaScript for all tutorials: Mermaid diagrams, modal expansion, code copy
---

<!-- Scale diagrams only when expanded in modal -->
<style is:global>
  /* Modal container - fullscreen overlay */
  .diagram-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .diagram-modal.active {
    opacity: 1;
  }

  /* Dark backdrop */
  .diagram-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
  }

  /* Content container - scrollable */
  .diagram-modal-content {
    position: relative;
    z-index: 10000;
    max-width: 95vw;
    max-height: 90vh;
    overflow: auto;
    background: #0d0d0f;
    border: 2px solid #04d9ff;
    border-radius: 0.5rem;
    padding: 2rem;
  }

  /* Close button */
  .diagram-modal-close {
    position: sticky;
    top: 0;
    right: 0;
    float: right;
    background: #1a1a1e;
    border: 1px solid #04d9ff;
    color: #04d9ff;
    font-size: 1.5rem;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
    z-index: 10001;
  }

  .diagram-modal-close:hover {
    background: #04d9ff;
    color: #0d0d0f;
  }

  /* Diagram scaling - responsive based on screen size */
  .diagram-modal-diagram {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    padding: 2rem;
  }

  /* Mobile - small scale */
  .diagram-modal-diagram pre.mermaid,
  .diagram-modal-diagram svg {
    transform: scale(1.5);
    transform-origin: center center;
  }

  /* Tablet - medium scale */
  @media (min-width: 640px) {
    .diagram-modal-diagram pre.mermaid,
    .diagram-modal-diagram svg {
      transform: scale(2.0);
      transform-origin: center center;
    }
  }

  /* Laptop - comfortable scale for 13-17" laptops */
  @media (min-width: 1024px) {
    .diagram-modal-diagram pre.mermaid,
    .diagram-modal-diagram svg {
      transform: scale(2.5);
      transform-origin: center center;
    }
  }

  /* Large desktop/curved monitors - full scale */
  @media (min-width: 1920px) {
    .diagram-modal-diagram pre.mermaid,
    .diagram-modal-diagram svg {
      transform: scale(3.2);
      transform-origin: center center;
    }
  }
</style>

<!-- Mermaid.js for diagrams -->
<script type="module" is:inline>
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  mermaid.initialize({
    startOnLoad: true,
    theme: 'dark',
    themeVariables: {
      // Background colors
      primaryColor: '#04d9ff',        // neonCyan
      primaryTextColor: '#ffffff',
      primaryBorderColor: '#04d9ff',

      secondaryColor: '#8b5cf6',      // neonPink (Violet Tech)
      secondaryTextColor: '#ffffff',
      secondaryBorderColor: '#8b5cf6',

      tertiaryColor: '#6366f1',       // neonPurple (Violet Tech)
      tertiaryTextColor: '#ffffff',
      tertiaryBorderColor: '#6366f1',

      // Node colors
      nodeTextColor: '#ffffff',
      mainBkg: '#1a1a1e',            // surface
      nodeBorder: '#04d9ff',
      clusterBkg: '#0d0d0f',         // background
      clusterBorder: '#04d9ff',

      // Line colors
      lineColor: '#04d9ff',
      arrowheadColor: '#04d9ff',

      // Text
      fontFamily: 'JetBrains Mono, monospace',
      fontSize: '18px',

      // Edge/Arrow styling
      edgeLabelBackground: '#1a1a1e',

      // Special node colors
      specialTextColor: '#8b5cf6',

      // Background
      darkMode: true,
    },
    flowchart: {
      curve: 'basis',
      padding: 20,
      nodeSpacing: 70,
      rankSpacing: 70,
      diagramPadding: 20,
      useMaxWidth: true,
    }
  });

  // Wait for mermaid to render, then add click handlers
  setTimeout(() => {
    const diagrams = document.querySelectorAll('pre.mermaid');

    diagrams.forEach(diagram => {
      diagram.style.cursor = 'pointer';
      diagram.setAttribute('title', 'Click to expand');

      diagram.addEventListener('click', () => {
        expandDiagram(diagram);
      });
    });
  }, 1000);

  function expandDiagram(diagramElement) {
    // Create modal overlay
    const modal = document.createElement('div');
    modal.className = 'diagram-modal';
    modal.innerHTML = `
      <div class="diagram-modal-backdrop"></div>
      <div class="diagram-modal-content">
        <button class="diagram-modal-close" aria-label="Close">âœ•</button>
        <div class="diagram-modal-diagram">
          ${diagramElement.outerHTML}
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    // Animate in
    requestAnimationFrame(() => {
      modal.classList.add('active');
    });

    // Close handlers
    const closeModal = () => {
      modal.classList.remove('active');
      setTimeout(() => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      }, 300);
    };

    modal.querySelector('.diagram-modal-close').addEventListener('click', closeModal);
    modal.querySelector('.diagram-modal-backdrop').addEventListener('click', closeModal);

    document.addEventListener('keydown', function escapeHandler(e) {
      if (e.key === 'Escape') {
        closeModal();
        document.removeEventListener('keydown', escapeHandler);
      }
    });
  }

  // Add copy buttons to code blocks
  document.addEventListener('DOMContentLoaded', () => {
    const codeBlocks = document.querySelectorAll('pre code');

    codeBlocks.forEach((codeBlock) => {
      const pre = codeBlock.parentElement;

      // Create copy button
      const copyButton = document.createElement('button');
      copyButton.className = 'copy-code-button';
      copyButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        <span class="copy-button-text">Copy</span>
      `;
      copyButton.setAttribute('aria-label', 'Copy code to clipboard');

      // Insert button inside pre element
      pre.style.position = 'relative';
      pre.appendChild(copyButton);

      // Copy functionality
      copyButton.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(codeBlock.textContent);

          // Update button to show "Copied!"
          copyButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <span class="copy-button-text">Copied!</span>
          `;
          copyButton.classList.add('copied');

          // Reset after 2 seconds
          setTimeout(() => {
            copyButton.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              <span class="copy-button-text">Copy</span>
            `;
            copyButton.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy code:', err);
        }
      });
    });
  });
</script>
