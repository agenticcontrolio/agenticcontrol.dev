---
import Layout from './Layout.astro';
import { tracks, getTrackTutorials, getPreviousTutorial, getNextTutorial } from '../data/tutorials';
import type { Tutorial } from '../data/tutorials';
import TutorialScripts from '../components/tutorial/TutorialScripts.astro';
import TutorialStyles from '../components/tutorial/TutorialStyles.astro';

interface Props {
  tutorial: Tutorial;
  title: string;
  description: string;
}

const { tutorial, title, description } = Astro.props;
const track = tracks[tutorial.track];
const trackTutorials = getTrackTutorials(tutorial.track);
const previousTutorial = getPreviousTutorial(tutorial.number, tutorial.track);
const nextTutorial = getNextTutorial(tutorial.number, tutorial.track);
const publishedCount = trackTutorials.filter(t => t.published).length;
---

<Layout title={title} description={description}>
  <!-- Breadcrumbs -->
  <nav class="bg-surface/60 border-b border-neonCyan/20 backdrop-blur-sm sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center gap-2 text-sm font-mono">
        <a href="/" class="text-neonCyan hover:text-neonCyan/80 transition">Home</a>
        <span class="text-slate-500">/</span>
        <a href="/technician-track" class={`text-${track.color} hover:opacity-80 transition`}>
          {track.icon} {track.name}
        </a>
        <span class="text-slate-500">/</span>
        <span class="text-slate-400">Tutorial {tutorial.number}</span>
      </div>
    </div>
  </nav>

  <div class="flex max-w-7xl mx-auto">
    <!-- Sidebar Navigation -->
    <aside class="hidden lg:block w-80 border-r border-surface/80 bg-vhs/40 sticky top-[57px] h-[calc(100vh-57px)] overflow-y-auto tutorial-sidebar mr-8">
      <div class="p-6">
        <!-- Track Header -->
        <div class="mb-6">
          <div class={`text-2xl font-display text-${track.color} mb-2 tracking-wider`}>
            {track.icon} {track.name}
          </div>
          <div class="text-sm text-slate-400 font-mono">
            {publishedCount}/{track.totalTutorials} Published
          </div>
          <!-- Progress Bar -->
          <div class="mt-3 h-2 bg-surface rounded-full overflow-hidden">
            <div
              class={`h-full bg-${track.color} transition-all duration-300`}
              style={`width: ${(publishedCount / track.totalTutorials) * 100}%`}
            ></div>
          </div>
        </div>

        <!-- Tutorial List -->
        <nav class="space-y-2">
          {trackTutorials.map((t) => {
            const isCurrent = t.number === tutorial.number;
            const isPublished = t.published;
            const baseClasses = "block px-4 py-3 rounded-lg border-2 transition-all duration-200";
            const stateClasses = isCurrent
              ? `bg-${track.color}/20 border-${track.color} text-${track.color}`
              : isPublished
                ? "border-slate-700 hover:border-neonCyan/40 hover:bg-surface/60 text-slate-300"
                : "border-slate-800 bg-vhs/60 text-slate-600 cursor-not-allowed";

            return (
              <a
                href={isPublished ? `/tutorials/${t.slug}` : "#"}
                class={`${baseClasses} ${stateClasses}`}
                aria-current={isCurrent ? "page" : undefined}
                aria-disabled={!isPublished}
              >
                <div class="flex items-start gap-3">
                  <div class={`flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center text-xs font-bold
                    ${isCurrent ? `border-${track.color} text-${track.color}` : isPublished ? "border-neonCyan text-neonCyan" : "border-slate-700 text-slate-600"}`}
                  >
                    {isPublished ? (isCurrent ? "‚ñ∂" : t.number) : "üîí"}
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class={`text-sm font-semibold mb-1 ${!isPublished && "line-through"}`}>
                      {t.title}
                    </div>
                    <div class="text-xs opacity-80 line-clamp-2">
                      {t.description}
                    </div>
                  </div>
                </div>
              </a>
            );
          })}
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 min-w-0">
      <!-- Mobile Track Info -->
      <div class="lg:hidden bg-surface/60 border-b border-neonCyan/20 p-4">
        <div class={`text-lg font-display text-${track.color} mb-1`}>
          {track.icon} {track.name}
        </div>
        <div class="text-sm text-slate-400">
          Tutorial {tutorial.number} of {track.totalTutorials}
        </div>
      </div>

      <!-- Tutorial Content -->
      <article class="px-4 lg:px-12 py-8">
        <slot />
      </article>

      <!-- Previous/Next Navigation -->
      <nav class="border-t border-surface/80 bg-vhs/40 px-4 lg:px-12 py-6">
        <div class="flex flex-col sm:flex-row gap-4 justify-between">
          <!-- Previous Tutorial -->
          {previousTutorial && previousTutorial.published ? (
            <a
              href={`/tutorials/${previousTutorial.slug}`}
              class="flex-1 group border-2 border-slate-700 hover:border-neonCyan/60 rounded-lg p-4 transition-all hover:bg-surface/60"
            >
              <div class="text-xs text-slate-500 mb-1 font-mono">‚Üê PREVIOUS</div>
              <div class="text-sm font-semibold text-neonCyan group-hover:text-neonCyan/80">
                Tutorial {previousTutorial.number}: {previousTutorial.title}
              </div>
            </a>
          ) : (
            <div class="flex-1"></div>
          )}

          <!-- Next Tutorial -->
          {nextTutorial && nextTutorial.published ? (
            <a
              href={`/tutorials/${nextTutorial.slug}`}
              class="flex-1 group border-2 border-slate-700 hover:border-neonCyan/60 rounded-lg p-4 transition-all hover:bg-surface/60 text-right"
            >
              <div class="text-xs text-slate-500 mb-1 font-mono">NEXT ‚Üí</div>
              <div class="text-sm font-semibold text-neonCyan group-hover:text-neonCyan/80">
                Tutorial {nextTutorial.number}: {nextTutorial.title}
              </div>
            </a>
          ) : nextTutorial && !nextTutorial.published ? (
            <div class="flex-1 border-2 border-slate-800 rounded-lg p-4 bg-vhs/60 text-right cursor-not-allowed">
              <div class="text-xs text-slate-600 mb-1 font-mono">NEXT ‚Üí</div>
              <div class="text-sm font-semibold text-slate-600 flex items-center justify-end gap-2">
                <span>üîí</span>
                <span>Tutorial {nextTutorial.number}: {nextTutorial.title}</span>
              </div>
              <div class="text-xs text-slate-600 mt-1">Coming Soon</div>
            </div>
          ) : (
            <div class="flex-1"></div>
          )}
        </div>

        <!-- Back to Track -->
        <div class="mt-6 text-center">
          <a
            href="/technician-track"
            class={`inline-block px-6 py-3 border-2 border-${track.color}/60 text-${track.color} rounded-lg font-semibold hover:bg-${track.color}/10 transition`}
          >
            ‚Üê Back to {track.name}
          </a>
        </div>
      </nav>
    </main>
  </div>

  <!-- Auto-include tutorial scripts and styles -->
  <TutorialScripts />
  <TutorialStyles />
</Layout>

<style>
  /* Smooth scrolling for sidebar */
  .tutorial-sidebar {
    scrollbar-width: thin;
    scrollbar-color: #04d9ff #1a1a1e;
  }

  .tutorial-sidebar::-webkit-scrollbar {
    width: 6px;
  }

  .tutorial-sidebar::-webkit-scrollbar-track {
    background: #1a1a1e;
  }

  .tutorial-sidebar::-webkit-scrollbar-thumb {
    background: #04d9ff;
    border-radius: 3px;
  }

  .tutorial-sidebar::-webkit-scrollbar-thumb:hover {
    background: #06b6d4;
  }
</style>
